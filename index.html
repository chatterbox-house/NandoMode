<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>NandoMode: Spanish Vocab Trainer</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Press Start 2P', cursive; max-width: 480px; margin: auto; padding: 10px; background: #fff; color: #000; image-rendering: pixelated; transition: background 0.3s, color 0.3s; }
    body.dark { background: #000; color: #fff; }
    h1, h2 { text-align: center; font-size: 1.2rem; color: #000; text-shadow: 2px 2px #fff; }
    body.dark h1, body.dark h2 { color: #fff; text-shadow: 2px 2px #000; }
    #score { text-align: center; font-size: 0.8rem; margin-bottom: 10px; color: #fff; background: #000; padding: 8px; border: 4px solid #fff; }
    body.dark #score { color: #000; background: #fff; border: 4px solid #000; }
    #progressBar { width: 100%; background: #fff; border: 4px solid #000; height: 16px; margin-bottom: 15px; }
    body.dark #progressBar { background: #000; border: 4px solid #fff; }
    #progress { height: 100%; background: #000; width: 0; transition: width 0.5s ease; }
    body.dark #progress { background: #fff; }
    #container { display: flex; justify-content: space-between; gap: 15px; margin-top: 15px; }
    #emojiColumn, #wordColumn { flex: 1; display: flex; flex-direction: column; gap: 10px; }
    .box { border: 4px solid #000; padding: 12px; text-align: center; font-size: 1.5rem; user-select: none; cursor: pointer; background: #fff; width: 100%; max-width: 140px; height: 70px; display: flex; align-items: center; justify-content: center; transition: transform 0.1s, background 0.3s; }
    body.dark .box { border: 4px solid #fff; background: #000; }
    .box:hover:not(.matched) { transform: scale(1.1); }
    .box.selected { background: #000; border-color: #fff; color: #fff; transform: scale(1.1); }
    body.dark .box.selected { background: #fff; border-color: #000; color: #000; }
    .wordBox { font-size: 1rem; }
    .matched { background: #FFD700 !important; cursor: default; border-color: #000; animation: pixelBounce 0.3s; }
    body.dark .matched { border-color: #fff; }
    .incorrect { animation: pixelShake 0.2s; }
    @keyframes pixelBounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @keyframes pixelShake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-4px); } 75% { transform: translateX(4px); } }
    #messages { text-align: center; font-size: 0.9rem; margin: 10px 0; min-height: 40px; color: #000; display: flex; align-items: center; justify-content: center; gap: 8px; }
    body.dark #messages { color: #fff; }
    #messages img { width: 24px; height: 24px; }
    #buttons { text-align: center; margin: 10px 0; }
    #leaderboard { margin-bottom: 20px; background: #fff; padding: 10px; border: 4px solid #000; }
    body.dark #leaderboard { background: #000; border: 4px solid #fff; }
    #leaderboard img { vertical-align: middle; width: 16px; height: 16px; margin-right: 5px; }
    #endScreen { text-align: center; padding: 20px; border: 4px solid #FFD700; background: #fff; background: #fff; margin-top: auto 20px; }
    body.dark #endScreen; { background: #000; }
    #endScreen h2 { font-size: 1.5rem; color: #FFD700; text-shadow: margin-bottom; 2px 2px #000; }
    #endScreen img.banner { width: 100%; max-width: 200px; margin: 10px 0; }
    #endScreen .current-user { font-weight: bold; color: #FFD700;; }
    button { margin: 4px; padding: 4px 10px; font-size: 12px; border: 2px solid #000; cursor: pointer; background: none; color: #000; font-family: 'Press Start 2P', cursive; }
    body.dark button { border: none; background: #fff; color: #000; }
    button:hover { background: #000; color: #fff; }
    body.dark button:hover { background: #fff; color: #000; }
    #playBtn { display: block; margin: 10px auto; padding: 15px 20px; font-size: 14px; }
    #finishEndBtn { font-size: 12px; padding: 8px 12px; }
    #loginSection { display: block; max-width: 300px; margin: 30px auto; padding: 20px; background: #fff; border: 2px solid #000; }
    body.dark #loginSection { background: #000; border: 2px solid #fff; }
    #loginSection label { display: block; margin: margin-bottom; 8px; font-size: 12px; }
    body.dark #loginSection label { color: #fff; }
    #login-items select, #loginSection input { width: 100%; padding: 8px; margin-bottom: 10px; font-size: 12px; border: 2px solid #000; background: none; color: #000; font-family: 'Press Start 2P', cursive; }
    body.dark #login-items select, body.dark #loginSection input { border: 2px solid #fff; color: #fff; }
    #login-items option img { vertical-align: middle; width: 12px; height: 12px; margin-right: 2px; }
    #loginError { color: red; font-size: 12px; margin-bottom: 10px; }
    canvas#confettiCanvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 10; }
    #themeToggle, #musicToggle { position: 100% fixed; top: 10px; width: 32px; height: 32px; background: none; border: 2px solid #000; cursor: pointer; z-index: 11; display: flex; align-items: center; justify-content: center; }
    #themeToggle { right: 10px;; }
    #musicToggle { right: 50px; }
    body.dark #themeToggle, body.dark #musicToggle { border: 2px solid #fff; background: #000; }
    #themeToggle::before { content: '‚òÄÔ∏è'; font-size: 14px; }
    body.dark #themeToggle::before { content: 'üåü'; }
    #musicToggle::before { content: 'üéµ'; font-size: 14px; }
    #musicToggle.off::before { content: 'üîá'; }
  </style>
</head>
<body>
  <h1>NandoMode</h1>
  <button id="themeToggleBtn"></button>
  <div id="loginSection">
    <div id="loginError"></div>
    <label for="username">Usuario:</label>
    <select id="username">
      <option value="">-- Seleccione un usuario --</option>
      <option value="Tony"><img src="assets/images/Tony.png"> Tony</option>
    <option value="Ana">><img src="Ana.png"> Ana</option>
    <option value="Sora"><img src="Sora.png"> Sora</option>
    <option>
    <option value="Kai"><img src="Kai.png"> Kai</option>
    <option value="Maria"><img src="Maria.png"> Mar√≠a</option>
  </select>
  <label for="password">PIN:</label>
  <input type="password" type="password" id="password" placeholder="Enter PIN">
  <button id="loginButton">LOGIN</button>
</div>

<div id="leaderboard" style="display:none;">
  <h2>Leaderboard</h2>
  <ol id="leaderboardList"></ol>
</div>

<div id="buttons" style="display:none;">
  <button id="startQuizBtn">Start Quiz</button>
  <button id="logoutBtn" style="display:none;">Logout</button>
</div>

<div id="messages"></div>

<div id="progressBar" style="display:none;">
  <div id="progress"></div>
</div>

<div id="score" style="display:none;">Matches: 0</div>

<div id="container" style="display:none;">
  <div id="emojiContainer"></div>
  <div id="wordContainer"></div>
</div>

<div id="endScreen" style="display:none;">
  <h2>¬°Bien Hecho!</h2>
  <img class="banner" src="assets/images/banner.png" alt="Victory Banner">
  <div id="endLeaderboard"></div>
  <button id="playBtn">Jugar ‚ñ∂</button>
  <button id="finishEndBtn">Terminar</button>
</div>

<canvas id="confettiCanvas"></canvas>

<script>
  let isSpeaking = false;
  let score = 0;
  let selectedEmoji = null;
  let selectedWord = null;
  const pairs = [
    { emoji: 'üçé', word: 'Manzana' },
    { emoji: 'üöó', word: 'Carro' },
    { emoji: 'üê∂', word: 'Perro' },
    { emoji: 'üåû', word: 'Sol' },
    { emoji: 'üìñ', word: 'Libro' }
  ];
  const users = {
    Tony: { pin: '1111', avatar: 'assets/images/avatar_tony.png' },
    Ana: { pin: '2222', avatar: 'assets/images/avatar_ana.png' },
    Sora: { pin: '3333', avatar: 'assets/images/avatar_sora.png' },
    Kai: { pin: '4444', avatar: 'assets/images/avatar_kai.png' },
    Maria: { pin: '5555', avatar: 'assets/images/avatar_maria.png' }
  };
  let currentUser = null;
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  let musicOscillator = null;
  let leaderboardData = JSON.parse(localStorage.getItem('leaderboard')) || [
    { name: 'Tony', score: 0, avatar: 'assets/images/avatar_tony.png' },
    { name: 'Ana', score: 0, avatar: 'assets/images/avatar_ana.png' },
    { name: 'Sora', score: 0, avatar: 'assets/images/avatar_sora.png' },
    { name: 'Kai', score: 0, avatar: 'assets/images/avatar_kai.png' },
    { name: 'Maria', score: 0, avatar: 'assets/images/avatar_maria.png' }
  ];

  function speakText(text) {
    speechSynthesis.cancel();
    isSpeaking = true;
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'es-ES';
    utterance.volume = 1;
    utterance.rate = 0.9;
    utterance.onend = () => { isSpeaking = false; };
    try { speechSynthesis.speak(utterance); } catch (e) { isSpeaking = false; }
  }

  function playSound(type) {
    try {
      isSpeaking = true;
      const oscillator = audioContext.createOscillator();
      oscillator.type = type === 'correct' ? 'sine' : 'square';
      oscillator.frequency.setValueAtTime(type === 'correct' ? 880 : 220, audioContext.currentTime);
      oscillator.connect(audioContext.destination);
      oscillator.start();
      oscillator.stop(audioContext.currentTime + 0.3);
      setTimeout(() => { isSpeaking = false; }, 300);
    } catch (e) { isSpeaking = false; }
  }

  function toggleMusic() {
    try {
      if (musicOscillator) {
        musicOscillator.stop();
        musicOscillator = null;
        localStorage.setItem('music', 'off');
        document.getElementById('musicToggle').classList.add('off');
      } else {
        musicOscillator = audioContext.createOscillator();
        musicOscillator.type = 'triangle';
        musicOscillator.frequency.setValueAtTime(110, audioContext.currentTime);
        const gainNode = audioContext.createGain();
        gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
        musicOscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        musicOscillator.start();
        localStorage.setItem('music', 'on');
        document.getElementById('musicToggle').classList.remove('off');
      }
    } catch (e) {}
  }

  const canvas = document.getElementById('confettiCanvas');
  const ctx = canvas.getContext('2d');
  let particles = [];

  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function createParticle() {
    return {
      x: Math.random() * canvas.width,
      y: Math.random() * canvas.height - canvas.height,
      size: Math.random() * 8 + 4,
      speedX: Math.random() * 4 - 2,
      speedY: Math.random() * 2 + 2,
      color: `hsl(${Math.random() * 360}, 100%, 50%)`
    };
  }

  function startConfetti() {
    resizeCanvas();
    particles = Array.from({ length: 50 }, createParticle);
    animateConfetti();
  }

  function animateConfetti() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    particles.forEach(p => {
      p.x += p.speedX;
      p.y += p.speedY;
      p.size *= 0.99;
      ctx.fillStyle = p.color;
      ctx.fillRect(p.x, p.y, p.size, p.size);
      if (p.size < 0.5 || p.y > canvas.height) {
        particles.splice(particles.indexOf(p), 1);
        particles.push(createParticle());
      }
    });
    if (particles.length) requestAnimationFrame(animateConfetti);
  }

  function updateLeaderboard(currentScore) {
    const username = currentUser || document.getElementById('username').value;
    const userEntry = leaderboardData.find(entry => entry.name === username);
    if (userEntry && currentScore > userEntry.score) {
      userEntry.score = currentScore;
      localStorage.setItem('leaderboard', JSON.stringify(leaderboardData));
    }
    const leaderboardList = document.getElementById('leaderboardList');
    const endLeaderboard = document.getElementById('endLeaderboard');
    leaderboardList.innerHTML = '';
    endLeaderboard.innerHTML = '';
    leaderboardData.forEach(entry => {
      const li = document.createElement('li');
      li.innerHTML = `<img src="${entry.avatar}" alt="${entry.name}"> ${entry.name}: ${entry.score}`;
      if (entry.name === username) li.classList.add('current-user');
      leaderboardList.appendChild(li);
      endLeaderboard.appendChild(li.cloneNode(true));
    });
  }

  document.getElementById('loginBtn').addEventListener('click', () => {
    const username = document.getElementById('username').value;
    const pin = document.getElementById('pin').value;
    const errorDiv = document.getElementById('loginError');
    if (users[username] && users[username].pin === pin) {
      currentUser = username;
      errorDiv.textContent = '';
      document.getElementById('loginSection').style.display = 'none';
      document.getElementById('buttons').style.display = 'block';
      document.getElementById('leaderboard').style.display = 'block';
      updateLeaderboard(0);
    } else {
      errorDiv.textContent = 'Usuario o PIN incorrecto';
    }
  });

  document.getElementById('startBtn').addEventListener('click', () => {
    document.getElementById('buttons').style.display = 'none';
    document.getElementById('container').style.display = 'flex';
    document.getElementById('score').style.display = 'block';
    document.getElementById('progressBar').style.display = 'block';
    startGame();
  });

  function startGame() {
    score = 0;
    document.getElementById('score').textContent = `Matches: ${score}`;
    document.getElementById('progress').style.width = '0%';
    const shuffledPairs = [...pairs].sort(() => Math.random() - 0.5);
    const emojis = shuffledPairs.map(p => p.emoji);
    const words = shuffledPairs.map(p => p.word).sort(() => Math.random() - 0.5);
    const emojiColumn = document.getElementById('emojiColumn');
    const wordColumn = document.getElementById('wordColumn');
    emojiColumn.innerHTML = '';
    wordColumn.innerHTML = '';
    emojis.forEach((emoji, i) => {
      const box = document.createElement('div');
      box.className = 'box emojiBox';
      box.textContent = emoji;
      box.dataset.word = shuffledPairs[i].word;
      box.addEventListener('click', () => handleBoxClick(box));
      emojiColumn.appendChild(box);
    });
    words.forEach(word => {
      const box = document.createElement('div');
      box.className = 'box wordBox';
      box.textContent = word;
      box.dataset.word = word;
      box.addEventListener('click', () => handleBoxClick(box));
      wordColumn.appendChild(box);
    });
    updateLeaderboard(0);
  }

  function handleBoxClick(box) {
    if (isSpeaking || box.classList.contains('matched')) {
      if (box.classList.contains('emojiBox')) {
        isSpeaking = true;
        speakText(box.dataset.word, () => { isSpeaking = false; });
      }
      return;
    }
    if (box.classList.contains('emojiBox')) {
      if (selectedEmoji === box) {
        box.classList.remove('selected');
        selectedEmoji = null;
      } else {
        if (selectedEmoji) selectedEmoji.classList.remove('selected');
        box.classList.add('selected');
        selectedEmoji = box;
        checkMatch();
      }
    } else {
      if (selectedWord === box) {
        box.classList.remove('selected');
        selectedWord = null;
      } else {
        if (selectedWord) selectedWord.classList.remove('selected');
        box.classList.add('selected');
        selectedWord = box;
        checkMatch();
      }
    }
  }

  function checkMatch() {
    if (selectedEmoji && selectedWord) {
      if (selectedEmoji.dataset.word === selectedWord.dataset.word) {
        selectedEmoji.classList.add('matched');
        selectedWord.classList.add('matched');
        score++;
        document.getElementById('score').textContent = `Matches: ${score}`;
        document.getElementById('progress').style.width = `${(score / pairs.length) * 100}%`;
        selectedEmoji.classList.remove('selected');
        selectedWord.classList.remove('selected');
        selectedEmoji = null;
        selectedWord = null;
        startConfetti();
        playSound('correct');
        setTimeout(() => {
          const messageDiv = document.getElementById('messages');
          messageDiv.innerHTML = `<img src="https://raw.githubusercontent.com/your-username/NandoMode/main/assets/images/cat_sprite.png" alt="Correct"> Correct!`;
          setTimeout(() => { messageDiv.innerHTML = ''; }, 1000);
        }, 300);
        if (score === pairs.length) {
          setTimeout(showEndScreen, 1000);
        }
      } else {
        selectedEmoji.classList.add('incorrect');
        selectedWord.classList.add('incorrect');
        playSound('incorrect');
        setTimeout(() => {
          const messageDiv = document.getElementById('messages');
          messageDiv.innerHTML = `<img src="https://raw.githubusercontent.com/your-username/NandoMode/main/assets/images/sad_sprite.png" alt="Incorrect"> Try again!`;
          selectedEmoji.classList.remove('selected', 'incorrect');
          selectedWord.classList.remove('selected', 'incorrect');
          selectedEmoji = null;
          selectedWord = null;
          setTimeout(() => { messageDiv.innerHTML = ''; }, 1000);
        }, 300);
      }
    }
  }

  function showEndScreen() {
    document.getElementById('container').style.display = 'none';
    document.getElementById('score').style.display = 'none';
    document.getElementById('progressBar').style.display = 'none';
    document.getElementById('endScreen').style.display = 'block';
    startConfetti();
    updateLeaderboard(score);
    document.getElementById('playBtn').addEventListener('click', () => {
      document.getElementById('endScreen').style.display = 'none';
      document.getElementById('buttons').style.display = 'block';
      document.getElementById('leaderboard').style.display = 'block';
      startGame();
    });
    document.getElementById('finishEndBtn').addEventListener('click', () => {
      document.getElementById('endScreen').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      document.getElementById('leaderboard').style.display = 'none';
    });
  }

  document.getElementById('themeToggle').addEventListener('click', () => {
    document.body.classList.toggle('dark');
    localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
  });

  window.addEventListener('load', () => {
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
    updateLeaderboard(0);
    document.getElementById('musicToggle').classList.add('off');
    document.getElementById('musicToggle').addEventListener('click', () => {
      if (audioContext.state === 'suspended') audioContext.resume().then(toggleMusic);
      else toggleMusic();
    });
  });
</script>
</body>
</html>
